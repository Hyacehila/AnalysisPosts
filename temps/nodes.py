import json
from pocketflow import Node,BatchNode
from llm_utils import call_llm 
"""
本文档中,全部的注释都需要重写,并且AnalyzeThemes的Batch化没有开始,
SentimentBasic的Batch化只进行了prep 步,exec 步,post步没开始写
SentimentThinking 的Batch化也没有开始写
"""

class AnalyzeThemes(Node):
    """
    一个用于分析博文主题的节点。
    它结合文本和图片信息，从现有的主题仓库中,通过多模态LLM识别核心主题。
    """
    def prep(self, shared):
        """
        从 shared 状态中准备执行所需的数据。
        
        Args:
            shared (dict): 包含博文内容和可选主题的共享状态字典。
                          - "textcontent": 博文的文本内容。
                          - "imageurls": 博文图片的URL列表。
                          - "themes": 供LLM参考的主题列表。

        Returns:
            dict: 包含所有输入数据的字典，将传递给 exec 方法。
        """
        return {
            "text": shared.get("textcontent", ""),
            "image_urls": shared.get("imageurls", []),
            "themes": shared.get("themes_optional", [])
        }

    def exec(self, prep_res):
        """
        执行核心任务：调用多模态LLM进行主题分析。
        
        Args:
            prep_res (dict): 由 prep 方法返回的数据字典。

        Returns:
            list: 一个包含已识别主题的字符串列表。
        """
        print("正在调用多模态LLM进行主题分析...")
        
        # 构建一个详细的提示词，指导LLM完成任务
        prompt = f"""
你是一个专业的社交媒体内容分析师。
你的任务是分析以下博文内容（包括文本和图片），并识别出其中最核心的几个主题。

博文文本： {prep_res['text']}

参考主题列表（你的分析结果应完全从中选择，哪怕超出此范围，也不要添加新主题，而是选择直接将其留白,输出空文件）：{prep_res['themes']}

请仔细阅读文本、观察图片，并结合参考列表，提炼出最能代表这篇博文核心内容的主题。

要求：
1.  主题要简洁、准确。
2.  最终输出一个 JSON 列表，列表中的每个字符串都是一个主题。
3.  不要包含任何解释或额外的文本，只返回纯粹的 JSON 格式。



输出示例:
{{
    "themes" : [
“themes1”,
“themes2”,
“themes3”
]
}}
"""     
        exec_res = call_llm(prompt,prep_res['image_urls'])
        themes_list_dict = json.loads(exec_res)
        #和LLM通讯,将提示词与链接交给LLM分析
        return themes_list_dict
    def post(self,shared, prep_res, exec_res) :
        shared['themes'] = exec_res
        return None

class SentimentBasic(BatchNode):
    """
    一个用于初步分析博文情感的节点。
    它结合文本和图片信息,通过多模态LLM识别情感。
    现在他的prep 以及 exec 步已经完成,我们只需要在post 步中处理返回的结果即可,这部分还没着手开始写.
    """
    def prep(self, shared):
        posts_list = shared.get('posts', [])
        
        # 遍历帖子列表，使用 yield 逐个返回处理好的数据,这里我们选择了返回生成器.
        for post in posts_list:
            yield {  # <-- 关键在这里！
                "text": post.get("textcontent", ""),
                "image_urls": post.get("imageurls", []),
            }
        return "迭代器已经终止,访问生成器的代码出错导致过度访问"


    def exec(self, prep_res):
        """
        执行核心任务：调用多模态LLM进行情感分析。
        
        Args:
            prep_res (dict): 由 prep 方法返回的数据生成器,每次返回一个包含文本和图片URL的字典。

        Returns:
            list: 一个包含情感分析结果的列表,每个元素都是一个代表情感极性的阿拉伯数字（1-5）。
        """
        print("正在调用多模态LLM进行情感分析...")
        
        # 构建一个详细的提示词，指导LLM完成任务
        prompt = f"""
你是一个专业的社交媒体内容分析师。
你的任务是分析以下博文内容（包括文本和图片）的整体情感极性。
情感极性评分标准如下：
1 - 非常负面 (例如：愤怒、绝望、极度不满)
2 - 负面 (例如：失望、担忧、轻微不满)
3 - 中性 (例如：事实陈述、客观描述、无明显情感倾向)
4 - 正面 (例如：开心、满意、期待)
5 - 非常正面 (例如：兴奋、感激、极度喜悦)
要求：
请仔细阅读文本、观察图片，并结合上述评分标准，对这篇博文的整体情感倾向做出判断。
你的最终输出必须只包含一个代表判断结果的阿拉伯数字（1-5）。
不要添加任何解释、标题、引言、JSON格式或其他任何文本。

--- 示例 1：非常负面 (1分) ---

博文文本： 我真是受够了！刚买的XX手机，充电时竟然直接爆炸了！差点把我的家给点了！这就是你们所谓的旗舰产品？垃圾！骗子！我要告到你们破产！

预期输出：
1

分析说明：博文使用了极其强烈的负面词汇（“受够了”、“爆炸”、“垃圾”、“骗子”），并描述了一个具有危险性和破坏性的事件。这完全符合“非常负面”的定义，表达了极度的愤怒和绝望。

--- 示例 2：负面 (2分) ---

博文文本： 等了两个星期的快递，今天终于收到了，结果发现商品有明显的划痕，跟卖家描述的“全新未拆封”完全不符。唉，真倒霉，还得费劲去退货。

预期输出：
2

分析说明：文本表达了失望和烦恼的情绪（“划痕”、“不符”、“倒霉”、“费劲”）。虽然情绪强烈，但未达到愤怒或绝望的程度，属于对一次糟糕购物体验的抱怨，因此归为“负面”。

--- 示例 3：中性 (3分) ---

博文文本： 市政府发布通知，为配合线路检修，明天上午9点至下午5点，城东区将计划性停电。请相关区域居民提前做好准备。

预期输出：
3

分析说明：这是一条纯粹的事实性通知，客观地传达了停电的时间、范围和原因。文本中不包含任何个人情感、观点或情绪色彩，是典型的“中性”内容。

--- 示例 4：正面 (4分) ---

博文文本： 今天去新开的咖啡店试了一下，环境很不错，拿铁的味道也超乎预期。服务员态度很友好，是一次愉快的体验，下次还会再来。😊

预期输出：
4

分析说明：博文使用了积极的词汇（“很不错”、“超乎预期”、“愉快”、“友好”），并表达了满意和再次光顾的意愿。整体情感是积极的，但情绪表达相对平和，属于典型的“正面”评价。

--- 示例 5：非常正面 (5分) ---

博文文本： 我愿意！！！这辈子最幸福的一天！他单膝跪下的那一刻，我感觉整个世界都亮了！感谢你出现在我的生命里，我的爱人！

预期输出：
5

分析说明：博文使用了最高级的情感表达（“最幸福”、“世界都亮了”），并描述了求婚成功这一人生重大喜悦时刻。文本中的多个感叹号极大地增强了情感的强度。这完全符合“非常正面”的定义，即兴奋、感激、极度喜悦。



博文文本： {prep_res['text']}

"""     
        result1 = call_llm(prompt,prep_res['image_urls'],model= "Qwen/Qwen3-VL-235B-A22B-Instruct")
        result2 = call_llm(prompt,prep_res['image_urls'],model= "Qwen/Qwen3-VL-235B-A22B-Instruct")
        #和LLM通讯,将提示词与链接交给LLM分析
        exec_res = [int(result1), int(result2)]
        return exec_res
    def post(self, shared, prep_res, exec_res):
        """
        处理LLM分析结果的后置逻辑。

        - 如果两个模型返回的情感分数相差小于1，则选择更接近中性(3)的那个分数，
        将其存入 shared['sentiment']，并返回 None。
        - 如果两个分数相差大于等于1，则认为存在分歧，返回 'Continue' 字符串，不修改 shared。
        """
        # 从 exec_res 列表中获取两个分数
        print("生成器测试代码")
        print(exec_res)
        print("生成器测试代码结束")
        score1 = exec_res[0]
        score2 = exec_res[1]

        # 计算两个分数的绝对差值
        diff = abs(score1 - score2)

        # 判断差值是否小于1
        if diff <= 1:
            # 如果差值小于1，找出更接近3的那个分数
            # 计算每个分数到3的距离
            dist1 = abs(score1 - 3)
            dist2 = abs(score2 - 3)

            # 选择距离更小的那个分数作为最终结果
            if dist1 <= dist2:
                final_score = score1
            else:
                final_score = score2
            
            # 将最终分数存入 shared
            shared['sentiment'] = final_score
            # 返回 None，表示流程可以继续
            return None
        else:
            # 如果差值大于等于1，则认为存在分歧，返回 'Continue'
            print("Continue")
            return 'Continue'

class SentimentThinking(Node):
    # 用于推理的情感分析模块,包含对未定义的情况进行推理情感分析,返回情感分析结果;补充长期记忆;引入Human in the loop
    def prep(self,shared):
        return {
            "text": shared.get("textcontent", ""),
            "image_urls": shared.get("imageurls", []),
        }
    def exec(self, prep_res):
        prompt = f"""
你是一个专业的社交媒体内容分析师。
你的任务是分析以下博文内容（包括文本和图片）的整体情感极性。
情感极性评分标准如下：
1 - 非常负面 (例如：愤怒、绝望、极度不满)
2 - 负面 (例如：失望、担忧、轻微不满)
3 - 中性 (例如：事实陈述、客观描述、无明显情感倾向)
4 - 正面 (例如：开心、满意、期待)
5 - 非常正面 (例如：兴奋、感激、极度喜悦)
要求：
请仔细阅读文本、观察图片，并结合上述评分标准，并一步一步的分析这篇博文的整体情感倾向。
你的最终输出必须只包含一个代表判断结果的阿拉伯数字（1-5）。
不要添加任何解释、标题、引言、JSON格式或其他任何文本。

--- 示例 1：非常负面 (1分) ---

博文文本： 我真是受够了！刚买的XX手机，充电时竟然直接爆炸了！差点把我的家给点了！这就是你们所谓的旗舰产品？垃圾！骗子！我要告到你们破产！

预期输出：
1

分析说明：博文使用了极其强烈的负面词汇（“受够了”、“爆炸”、“垃圾”、“骗子”），并描述了一个具有危险性和破坏性的事件。这完全符合“非常负面”的定义，表达了极度的愤怒和绝望。

--- 示例 2：负面 (2分) ---

博文文本： 等了两个星期的快递，今天终于收到了，结果发现商品有明显的划痕，跟卖家描述的“全新未拆封”完全不符。唉，真倒霉，还得费劲去退货。

预期输出：
2

分析说明：文本表达了失望和烦恼的情绪（“划痕”、“不符”、“倒霉”、“费劲”）。虽然情绪强烈，但未达到愤怒或绝望的程度，属于对一次糟糕购物体验的抱怨，因此归为“负面”。

--- 示例 3：中性 (3分) ---

博文文本： 市政府发布通知，为配合线路检修，明天上午9点至下午5点，城东区将计划性停电。请相关区域居民提前做好准备。

预期输出：
3

分析说明：这是一条纯粹的事实性通知，客观地传达了停电的时间、范围和原因。文本中不包含任何个人情感、观点或情绪色彩，是典型的“中性”内容。

--- 示例 4：正面 (4分) ---

博文文本： 今天去新开的咖啡店试了一下，环境很不错，拿铁的味道也超乎预期。服务员态度很友好，是一次愉快的体验，下次还会再来。

预期输出：
4

分析说明：博文使用了积极的词汇（“很不错”、“超乎预期”、“愉快”、“友好”），并表达了满意和再次光顾的意愿。整体情感是积极的，但情绪表达相对平和，属于典型的“正面”评价。

--- 示例 5：非常正面 (5分) ---

博文文本： 我愿意！！！这辈子最幸福的一天！他单膝跪下的那一刻，我感觉整个世界都亮了！感谢你出现在我的生命里，我的爱人！

预期输出：
5

分析说明：博文使用了最高级的情感表达（“最幸福”、“世界都亮了”），并描述了求婚成功这一人生重大喜悦时刻。文本中的多个感叹号极大地增强了情感的强度。这完全符合“非常正面”的定义，即兴奋、感激、极度喜悦。

博文文本： 啊fads发顺丰的是啥发的啥饭阿斯顿沙发垫
预期输出：
0


博文文本： {prep_res['text']}

"""     
        exec_res = int(call_llm(prompt,prep_res['image_urls'],model= "Qwen/Qwen3-VL-235B-A22B-Instruct"))
        return exec_res
    def post(self, shared, prep_res, exec_res):
        shared['sentiment'] = exec_res
        print("推理情感分析结束")
        return None
